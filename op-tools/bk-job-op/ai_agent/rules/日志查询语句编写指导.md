---
# 注意不要修改本文头文件，如修改，CodeBuddy（内网版）将按照默认逻辑设置
type: always
---

# 日志查询语句编写指导

## 概述

本规则指导如何使用 KQL (Kibana Query Language) 语法编写蓝鲸作业平台的日志查询语句。查询语句用于 `searchLogsByCondition` 工具的 `queryString` 参数。

## 基础查询语句

### 1. 通过 request_id 查询整个链路请求

**用途**：查询某个任务执行的完整链路日志

**语法**：
```
request_id: "{request_id}"
```

**示例**：
```
request_id: "b02df4aec7bd263a9b4f727eb605fad9"
```

### 2. 查询 GSE 调用日志

**用途**：查询调用 GSE（管控平台）的请求和返回日志

**语法**：
```
path: "/data/logs/job-execute/gse.log"
```

### 3. 查询 CMDB 调用日志

**用途**：查询调用 CMDB（配置平台）的请求和返回日志

**语法**：
```
path: "/data/logs/{服务名}/cmdb.log"
```

**服务名可选值**：
- `job-execute` - 作业执行服务
- `job-manage` - 作业管理服务
- `job-backup` - 作业备份服务
- `job-crontab` - 定时任务服务
- `job-file-gateway` - 文件网关服务
- `job-logsvr` - 日志服务

**示例**：
```
path: "/data/logs/job-execute/cmdb.log"
path: "/data/logs/job-manage/cmdb.log"
```

### 4. 查询错误日志

**用途**：查询 ERROR 级别的日志，用于排查问题

**语法**：
```
level: ERROR
```

## 组合查询

多个查询条件可以使用 `AND` 关键字组合，实现更精确的日志筛选。

### 组合语法

```
条件1 AND 条件2 AND 条件3
```

### 常用组合查询示例

#### 1. 查询某个任务的错误日志

```
request_id: "b02df4aec7bd263a9b4f727eb605fad9" AND level: ERROR
```

#### 2. 查询某个任务的 GSE 调用日志

```
request_id: "b02df4aec7bd263a9b4f727eb605fad9" AND path: "/data/logs/job-execute/gse.log"
```

#### 3. 查询某个任务的 CMDB 调用日志

```
request_id: "b02df4aec7bd263a9b4f727eb605fad9" AND path: "/data/logs/job-execute/cmdb.log"
```

#### 4. 查询某个任务的 GSE 调用错误日志

```
request_id: "b02df4aec7bd263a9b4f727eb605fad9" AND path: "/data/logs/job-execute/gse.log" AND level: ERROR
```

#### 5. 查询所有服务的 CMDB 错误日志

```
path: "*cmdb.log" AND level: ERROR
```

## 查询场景指南

| 场景           | 推荐查询语句                                                           |
|--------------|------------------------------------------------------------------|
| 排查任务执行失败     | `request_id: "{id}" AND level: ERROR`                            |
| 分析 GSE 调用问题  | `request_id: "{id}" AND path: "/data/logs/job-execute/gse.log"`  |
| 分析 CMDB 调用问题 | `request_id: "{id}" AND path: "/data/logs/job-execute/cmdb.log"` |
| 查看任务完整链路     | `request_id: "{id}"`                                             |
| 查看系统错误概览     | `level: ERROR`                                                   |

## 注意事项

1. **引号使用**：`request_id` 的值必须用双引号包裹
2. **大小写敏感**：字段名和关键字（如 `AND`、`ERROR`）需要注意大小写
3. **路径精确匹配**：`path` 字段的值需要是完整的日志文件路径
4. **时间范围**：配合 `timeRange` 参数使用，默认查询最近 1 天的日志
5. **结果数量**：配合 `size` 参数控制返回的日志条数，建议根据需要设置合适的值
