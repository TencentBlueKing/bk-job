---
# 注意不要修改本文头文件，如修改，CodeBuddy（内网版）将按照默认逻辑设置
type: always
---

# 蓝鲸作业平台任务日志查询规则

## 概述

当用户发起与蓝鲸作业平台任务相关的查询时，用户可能以三种不同形式提供任务标识信息。你需要识别用户输入的形式，并按照对应的处理流程调用 MCP 工具完成查询。

## 输入形式识别

### 1. 作业平台 Web 链接

**特征**：
- URL 形式，包含 `job.` 域名或类似的作业平台域名
- URL 中包含 `stepInstanceId` 参数
- 示例：`https://job.example.com/biz/1/execute/quick-launch/41612345678?from=historyList&executeCount=0&stepInstanceId=4329876543`

**识别规则**：
- 检测输入是否为 URL 格式（以 `http://` 或 `https://` 开头）
- 检测 URL 是否包含 `stepInstanceId=` 参数

### 2. stepInstanceId（步骤实例ID）

**特征**：
- 纯数字字符串
- 通常为 11 位或更多位数字
- 示例：`4329876543`

**识别规则**：
- 输入为纯数字字符串
- 不是 URL 格式
- 不包含字母字符

### 3. request_id（请求ID）

**特征**：
- 包含字母和数字的混合字符串
- 通常为 UUID 格式或类似的唯一标识符
- 示例：`b02df4aec7bd263a9b4f727eb605fad9`

**识别规则**：
- 输入包含字母和数字
- 不是 URL 格式
- 不是纯数字

## 处理流程

### 流程 A：从 Web 链接查询日志

```
输入：作业平台 Web 链接
   ↓
步骤1：从 URL 中提取 stepInstanceId 参数值
   ↓
步骤2：调用 searchRequestIdByStepInstanceId 工具，传入 stepInstanceId，获取 request_id
   ↓
步骤3：调用 searchLogsByCondition 工具，使用 request_id 查询整个链路日志
   ↓
输出：返回任务执行的完整链路日志
```

### 流程 B：从 stepInstanceId 查询日志

```
输入：stepInstanceId（纯数字）
   ↓
步骤1：调用 searchRequestIdByStepInstanceId 工具，传入 stepInstanceId，获取 request_id
   ↓
步骤2：调用 searchLogsByCondition 工具，使用 request_id 查询整个链路日志
   ↓
输出：返回任务执行的完整链路日志
```

### 流程 C：从 request_id 直接查询日志

```
输入：request_id（字母数字混合）
   ↓
步骤1：直接调用 searchLogsByCondition 工具，使用 request_id 查询整个链路日志
   ↓
输出：返回任务执行的完整链路日志
```

## MCP 工具调用说明

### searchRequestIdByStepInstanceId

**用途**：通过 stepInstanceId 查询对应的 request_id

**参数**：
- `stepInstanceId`（必填）：作业步骤实例ID，字符串类型

**调用示例**：
```json
{
  "stepInstanceId": "4329876543"
}
```

### searchLogsByCondition

**用途**：通过 KQL 查询语句搜索日志

**参数**：
- `queryString`（必填）：KQL 语法的查询语句，使用 request_id 查询时格式为 `request_id: "xxx"`
- `timeRange`（可选）：预定义时间范围，如 `1d`、`1h`、`15m`，默认 `1d`
- `size`（可选）：每页返回的日志条数，默认 10，建议不超过 100
- `start`（可选）：分页起始位置，从 0 开始

**调用示例**：
```json
{
  "queryString": "request_id: \"b02df4aec7bd263a9b4f727eb605fad9\"",
  "timeRange": "1d",
  "size": 50
}
```

## 注意事项

1. **URL 解析**：从 URL 中提取 `stepInstanceId` 时，注意处理 URL 编码和特殊字符
2. **错误处理**：如果 `searchRequestIdByStepInstanceId` 返回空结果，应告知用户未找到对应的 request_id
3. **时间范围**：默认查询最近 1 天的日志，如果用户指定了时间范围，应使用用户指定的值
4. **日志数量**：根据用户需求调整返回的日志条数，默认建议 50 条以获取较完整的链路信息
5. **用户需求理解**：在识别任务标识后，还需理解用户的具体需求（如排查问题、分析性能等），在返回日志后给出相应的分析和建议
