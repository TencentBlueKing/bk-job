# 迁移工具设计文档

本文档描述 BK-JOB 多租户迁移工具的内部设计，包括数据流转过程、临时数据库结构、表命名规则等。

## 整体架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    sourceDb     │     │      tmpDb      │     │    targetDb     │
│   (生产老环境)   │ ──▶ │   (临时数据库)   │ ──▶ │   (生产新环境)   │
│    只读访问      │     │    读写操作      │     │    写入数据      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

**设计原则**：
- 不在 sourceDb 上做任何写操作，只读取
- 所有数据转换操作在 tmpDb 中完成
- 最终处理好的数据写入 targetDb

---

## 数据流转过程

### 阶段1：Dump 源数据

```
sourceDb                              文件系统
├── job_manage (25张表)    ─────▶    source_dump/job_manage.sql
├── job_crontab (1张表)    ─────▶    source_dump/job_crontab.sql
└── job_file_gateway (2张表) ─────▶  source_dump/job_file_gateway.sql
```

**执行脚本**：`tool_dump_source_db.sh`

**说明**：
- 使用 `mysqldump` 导出**指定表**的结构和数据
- 只导出需要迁移的表，不是整个数据库
- 生成的 SQL 文件保存在 `source_dump/` 目录

### 阶段2：准备临时数据库

```
文件系统                              tmpDb
source_dump/job_manage.sql    ─────▶  new_job_manage (25张表)
source_dump/job_crontab.sql   ─────▶  new_job_crontab (1张表)
source_dump/job_file_gateway.sql ──▶  new_job_file_gateway (2张表)

同时创建：
  - bk_job_migration（空库，用于存储临时映射表）
  - global_job_manage（空库，用于全局迁移）
```

**执行脚本**：`tool_prepare_db.sh`

**说明**：
- 导入前会先 `DROP DATABASE` 再 `CREATE DATABASE`，确保干净
- 临时库名添加 `new_` 前缀，与 sourceDb 库名区分

### 阶段3：按业务生成迁移数据

以迁移业务 `bk_scope_id=1`（假设对应 `app_id=100`）为例：

```
new_job_manage                        new_job_manage
├── account          ─────▶          ├── account_100
├── script           ─────▶          ├── script_100
├── script_version   ─────▶          ├── script_version_100
├── task_template    ─────▶          ├── task_template_100
├── ...              ─────▶          ├── ...
└── (源数据表)                        └── (业务临时表)
```

**执行脚本**：`1_gen_migration_data.sh`

**说明**：
- 从源数据表中按 `app_id` 过滤数据，插入到业务临时表
- 临时表名格式：`{原表名}_{sourceAppId}`
- 在临时表上执行数据转换（补充 tenant_id、替换 app_id 等）

### 阶段4：导出并应用到目标环境

```
new_job_manage                   文件系统                      targetDb
├── account_100     ─────▶      sql/1/job_manage/...  ─────▶  job_manage
├── script_100      ─────▶      sql/1/job_manage/...  ─────▶  job_manage
└── ...             ─────▶      sql/1/...             ─────▶  ...
```

**执行脚本**：
- `1_gen_migration_data.sh`（导出 SQL 文件）
- `2_apply_migration_data.sh`（应用到 targetDb）

---

## 临时数据库结构

### 库清单

| 库名 | 用途 | 创建时机 |
|------|------|---------|
| `new_job_manage` | 存储 job_manage 的源数据副本 + 业务临时表 | `tool_prepare_db.sh` |
| `new_job_crontab` | 存储 job_crontab 的源数据副本 + 业务临时表 | `tool_prepare_db.sh` |
| `new_job_file_gateway` | 存储 job_file_gateway 的源数据副本 + 业务临时表 | `tool_prepare_db.sh` |
| `bk_job_migration` | 存储迁移过程中的临时映射表 | `tool_prepare_db.sh` |
| `global_job_manage` | 全局资源迁移用 | `tool_prepare_db.sh` |

### 表分类

每个临时库中包含两类表：

#### 1. 源数据表（来自 dump）

与 sourceDb 中的表同名，包含**全部业务**的数据。

```
new_job_manage
├── account          # 所有业务的账号
├── script           # 所有业务的脚本
├── task_template    # 所有业务的作业模板
└── ...
```

#### 2. 业务临时表（按业务过滤）

表名格式：`{原表名}_{sourceAppId}`，只包含**指定业务**的数据。

```
new_job_manage（迁移 app_id=100 的业务时）
├── account_100          # 业务100的账号
├── script_100           # 业务100的脚本
├── task_template_100    # 业务100的作业模板
└── ...
```

---

## 迁移业务时的完整表清单

假设迁移业务 `bk_scope_id=1`，对应 `app_id=100`：

### new_job_manage 库

| 源数据表（来自 dump） | 业务临时表（迁移时创建） |
|----------------------|------------------------|
| `account` | `account_100` |
| `script` | `script_100` |
| `script_version` | `script_version_100` |
| `task_template` | `task_template_100` |
| `task_template_step` | `task_template_step_100` |
| `task_template_step_approval` | `task_template_step_approval_100` |
| `task_template_step_file` | `task_template_step_file_100` |
| `task_template_step_file_list` | `task_template_step_file_list_100` |
| `task_template_step_script` | `task_template_step_script_100` |
| `task_template_variable` | `task_template_variable_100` |
| `task_plan` | `task_plan_100` |
| `task_plan_step` | `task_plan_step_100` |
| `task_plan_step_approval` | `task_plan_step_approval_100` |
| `task_plan_step_file` | `task_plan_step_file_100` |
| `task_plan_step_file_list` | `task_plan_step_file_list_100` |
| `task_plan_step_script` | `task_plan_step_script_100` |
| `task_plan_variable` | `task_plan_variable_100` |
| `credential` | `credential_100` |
| `notify_trigger_policy` | `notify_trigger_policy_100` |
| `notify_policy_role_target` | `notify_policy_role_target_100` |
| `notify_role_target_channel` | `notify_role_target_channel_100` |
| `task_favorite_plan` | `task_favorite_plan_100` |
| `task_favorite_template` | `task_favorite_template_100` |
| `tag` | `tag_100` |
| `resource_tag` | `resource_tag_100` |

### new_job_crontab 库

| 源数据表 | 业务临时表 |
|---------|-----------|
| `cron_job` | `cron_job_100` |

### new_job_file_gateway 库

| 源数据表 | 业务临时表 |
|---------|-----------|
| `file_source` | `file_source_100` |
| `file_source_share` | `file_source_share_100` |

### bk_job_migration 库

| 临时表 | 用途 | 生命周期 |
|--------|------|---------|
| `app_id_mapping_100` | file_source_share 的 app_id 映射缓存 | 处理完后删除 |

---

## 数据转换操作

在业务临时表上执行的转换操作：

### 1. 补充 tenant_id 字段

以下表需要补充 `tenant_id` 字段（V3.12.0 新增）：

| 表 | 操作 |
|----|------|
| `script_{appId}` | `ALTER TABLE ... ADD COLUMN tenant_id` + `UPDATE ... SET tenant_id` |
| `file_source_{appId}` | `ALTER TABLE ... ADD COLUMN tenant_id AFTER id` + `UPDATE ... SET tenant_id` |

### 2. 替换 app_id 字段

当 sourceAppId ≠ targetAppId 时，需要替换以下表的 `app_id`：

| 库 | 表 |
|----|-----|
| job_manage | account, script, task_template, task_plan, credential, notify_trigger_policy, task_favorite_plan, task_favorite_template, tag |
| job_crontab | cron_job |
| job_file_gateway | file_source |

### 3. 处理 file_source_share 的跨业务 app_id

`file_source_share.app_id` 表示"可以使用该文件源的业务ID"，可能是其他业务的 app_id。

处理逻辑：
1. 获取 file_source_share 中所有不同的 app_id
2. 对每个 app_id，从 sourceDb 查 bk_scope_id，再从 targetDb 查新的 app_id
3. 建立映射关系，更新或删除记录

### 4. 禁用定时任务

```sql
UPDATE cron_job_{appId} SET is_enable=0;
```

---

## 文件目录结构

```
tenant-migrate/
├── source_dump/                    # dump 的 SQL 文件
│   ├── job_manage.sql
│   ├── job_crontab.sql
│   └── job_file_gateway.sql
├── sql/                            # 生成的迁移 SQL 文件
│   ├── global/                     # 全局资源
│   │   └── job_manage/
│   ├── 1/                          # 业务 bk_scope_id=1
│   │   ├── job_manage/
│   │   ├── job_crontab/
│   │   └── job_file_gateway/
│   └── 2/                          # 业务 bk_scope_id=2
│       ├── job_manage/
│       ├── job_crontab/
│       └── job_file_gateway/
└── *.sh                            # 迁移脚本
```

---

## 为什么需要临时数据库？

1. **不影响生产环境**：所有转换操作在 tmpDb 中进行，sourceDb 只读
2. **支持独立部署**：tmpDb 可以是独立的 MySQL 实例，不需要与 sourceDb 在同一实例
3. **便于调试**：可以随时查看 tmpDb 中的中间数据
4. **支持重复执行**：每次 `tool_prepare_db.sh` 都会重建 tmpDb，确保干净

