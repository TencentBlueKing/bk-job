# 多租户环境下的CMDB事件监听处理与负载均衡机制技术方案

**1.CMDB提供的接口支持**  
（1）CMDB提供事件监听接口，支持对业务、主机等资源变动进行监听，实现上采用短长链的设计，当用户通过游标进行事件监听时，如果没有事件，则会保持会话连接，在20s内有事件变更则直接直接将事件推回，避免用户不断请求，同时保证用户能及时拿到变更的数据；  
（2）调用事件监听接口时，必须指定租户与资源类型，不支持跨租户或跨资源监听事件。  

**2.设计目标**  
作业平台的核心业务流程需要使用业务、业务集、业务集关系、主机、主机关系这几种资源，在高频访问资源数据的同时还存在某些与非CMDB数据关联的复杂查询，从系统整体性能与可靠性等角度出发，设计了资源监听与资源同步机制来构建本地缓存数据，实现以下目标：  
（1）高可用：作业平台单日任务量超过千万，峰值QPS超过1500，主机校验等场景下不宜直接调用CMDB接口，需要有本地缓存数据支撑；  
（2）高实时：用户在CMDB中更改或转移业务主机后，能够立即在作业平台中感知变化并使用；  
（3）高可靠：数据准确性高，针对某些异常情况（如事件延迟与丢失）能够自动修复数据，而非让误差累积；  
（4）租户隔离：A租户的事件堆积处理延迟，不影响B租户的事件处理。  

**3.实现方案**  
（1）各租户事件监听处理  
针对关注的业务、业务集、业务集关系、主机、主机关系这几种资源，为每个租户每个资源开启独立的线程进行监听，确保租户间的线程隔离；  
对于变动频率较低的业务、业务集、业务集关系事件，收到事件后直接在监听线程中处理；  
对于变动频率中等的主机关系事件，且由于该事件存在前后依赖性，因此在异步线程中按顺序处理，同时增加队列、处理延迟等监控指标；  
对于变动频率较高的主机事件，该事件只在同一主机上存在前后依赖性，因此在保证同一主机事件按顺序处理的基础上，使用多个线程并行处理，提高处理效率。  
  
（2）后台任务负载均衡机制  
在多租户环境下，租户数量的增加会导致创建大量事件监听与处理线程，这些线程如果位于同一实例，会导致资源竞争影响整体性能；  
为解决该问题，结合消息队列设计了后台任务负载均衡机制，事件监听任务作为后台任务的一种，会被均衡器均匀调度到环境中的所有实例；  
均衡器核心逻辑：  
a.计算当前环境中所有租户下需要开启的后台任务总共需要消耗的线程数量，获取健康实例数量，计算每个实例应当承担的线程数均值；  
b.将线程数均值与当前实例已承担的线程数进行对比，如果承担的任务过多，则关闭自身任务接收渠道，将超出的任务关闭，并通过发送MQ消息将其转移至其他实例；  
c.如果当前实例承担的任务达不到线程数均值，则打开自身任务接收渠道，接收其他实例转移的任务并执行；  
d.整个负载均衡机制中需要考虑分布式唯一性、边界问题、承担任务数达到临界值时的任务振荡与优雅关闭问题，在实现中作出相关处理。  
  
（3）定期资源全量同步  
作为事件监听的补充机制，定期全量同步各个租户下的各种资源，消除事件延迟或丢失导致的误差累积，在同步数据与事件数据的一致性上，使用CMDB资源最后更新时间作为可信版本数据，避免旧数据覆盖新数据，确保缓存数据准确性。  
